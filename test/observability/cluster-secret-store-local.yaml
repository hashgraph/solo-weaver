# ClusterSecretStore for local development
# This configures External Secrets Operator to connect to the local Vault instance

---
# Vault credentials secret
apiVersion: v1
kind: Secret
metadata:
  name: vault-credentials
  namespace: kube-system
type: Opaque
stringData:
  password: "eso-password"

---
# ConfigMap to help determine the correct Vault URL
# This will be used by the init script
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-config
  namespace: kube-system
data:
  vault-url: "REPLACE_WITH_NODE_IP"

---
# ClusterSecretStore pointing to local Vault
# Note: The server URL will be updated by the vault:setup-secret-store task
apiVersion: external-secrets.io/v1
kind: ClusterSecretStore
metadata:
  name: vault-secret-store
spec:
  provider:
    vault:
      # This will be updated by: task vault:setup-secret-store
      # For kubeadm: Uses the node's internal IP
      # Pattern: http://<node-ip>:8200
      server: "REPLACE_WITH_NODE_IP"
      path: "secret"
      version: v2
      auth:
        userPass:
          path: userpass
          username: "eso-user"
          secretRef:
            name: vault-credentials
            namespace: kube-system
            key: password

---
# Note: Vault is running in Docker on the VM host
# ESO pods need to access it from inside Kubernetes (different network namespace)
#
# For kubeadm clusters (what weaver uses):
#   - Pods cannot use 'localhost' to reach the VM host
#   - We need to use the node's internal IP address
#   - Run: task vault:setup-secret-store (auto-configures the correct IP)
