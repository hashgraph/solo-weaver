# Design assumptions:
# - Each workflow can have nested workflows, allowing for complex tasks to be broken down into smaller workflows and steps.
# - A step instance is reusable, so cannot be stateful. State is managed by the workflow execution context (ctx).
# - Each step can have a "run" method that executes the step, which can be a shell command, a script, or any other executable action.
# - Each step can have a "run" method that executes the step, and a "rollback" method that undoes the step.
# - If a step has no rollback, it can be marked with "skip: true" to indicate that it should not be rolled back.
KubernetesSetupWorkflow:
  description: Production-grade Kubernetes cluster provisioning on Ubuntu 22.04
  user: root # All steps are run as root by default, unless specified otherwise.
  workflows:
    - name: SetupProvisionerDirectoryStructureWorkflow
      description: Set up required directories and file structure for provisioner
      steps:
        - name: CreateDirectoriesStep
          description: Create working directories for temporary downloads and unpacking
          run:
            args:
              - /tmp/provisioner
              - /tmp/provisioner/logs
              - /tmp/provisioner/config
              - /tmp/provisioner/downloads
              - /tmp/provisioner/unpack
              - /tmp/provisioner/backup
          rollback:
            skip: false # by default, rollback is not skipped, so we can delete all directories created by this step.
        - name: CreateDirectoriesStep
          description: Create main provisioner directories for binaries, logs, and config
          run:
            args:
              - /opt/provisioner
              - /opt/provisioner/bin
              - /opt/provisioner/logs
              - /opt/provisioner/config
          rollback:
            skip: false # by default, rollback is not skipped, so we can delete all directories created by this step.
        - name: CreateDirectoriesStep
          description: Create sandbox directories for binaries, configuration, runtime, and storage
          run:
            - /opt/sandbox/bin
            - /opt/sandbox/config
            - /opt/sandbox/run
            - /opt/sandbox/storage
          rollback:
            skip: false # by default, rollback is not skipped, so we can delete all directories created by this step.
    - name: PrepareOperatingSystemWorkflow
      description: Prepare and configure the base system for Kubernetes installation
      workflows:
        - name: UpdateOperatingSystemWorkflow
          description: Update and upgrade the operating system
          steps:
            - name: BashScriptStep
              description: Update system packages
              run:
                args:
                  - "apt update"
              rollback:
                skip: true # Nop. We cannot undo this, can we?
            - name: BashScriptStep
              description: Upgrade system packages
              run:
                args:
                  - "apt upgrade -y"
              rollback:
                skip: true # Nop. We cannot undo this, can we?
        - name: DisableSwapWorkflow
          description: Disable swap
          steps:
            - name: CopyFileStep
              description: Backup original /etc/fstab if it exists
              run:
                args:
                  - "/etc/fstab" # src
                  - "/tmp/provisioner/backup/fstab.original" # dst
                  - "false" # do not overwrite if dst exists
              rollback:
                skip: true # Nop. We don't want to delete the original backup file, since repeated rollback could cause us losing the original fstab.
            - name: CopyFileStep
              description: Restore original /etc/fstab if it exists
              run:
                args:
                  - "/tmp/provisioner/backup/fstab.original" # src
                  - "/etc/fstab" # dst
                  - "true" # overwrite if dst exists
              rollback:
                skip: true # Nop. We don't want to delete the original backup file, since repeated rollback could cause us losing the original fstab.
            - name: DisableSwapStep
              description: Disable swap in the system
              run:
                args:
                  - "s/^\(.*\sswap\s.*\)$/#\1\n/" # regex to comment out swap line in /etc/fstab
                  - "/etc/fstab" # file to modify
                  - "swapoff -a" # bash command to disable swap
              rollback:
                skip: true # Nop. We cannot undo this, can we?
                args:
                  - "/tmp/provisioner/backup/fstab.original" # original file to restore
                  - "swapoff -a" # bash command to restore swap
        - name: CleanupContainerdWorkflow
          description: Clean up any existing containerd installations
          steps:
            - name: RemovePackagesStep
              description: Remove containerd package
              run:
                args:
                  - "containerd"
                  - "true" # force
              rollback:
                skip: true # Nop. We cannot undo this, can we?
            - name: RemovePackagesStep
              description: Remove containerd.io package
              run:
                args:
                  - "containerd.io"
                  - "true" # force
              rollback:
                skip: true # Nop. We cannot undo this, can we?
    - name: LoadKernelModulesWorkflow
      description: Load necessary kernel modules for Kubernetes networking
      steps:
        - name: LoadModulesStep # potentially it can be BashScriptStep instead of a custom step to handle loading kernel modules.
          description: Load overlay filesystem modules for Kubernetes networking
          run:
            args: # pass the bash commands to run
              - "modprobe overlay" # FIXME: is modprobe the right command to load the overlay module across all OS versions?
              - 'echo "overlay" | sudo tee /etc/modules-load.d/overlay.conf'
          rollback:
            args: # pass the bash commands to run
              - "rm -f /etc/modules-load.d/overlay.conf" # remove the overlay module load configuration
              - "modprobe -r overlay" # remove the overlay module
        - name: LoadModulesStep
          description: Load bridge netfilter modules for Kubernetes networking
          run:
            args: # pass the bash commands to run
              - "modprobe br_netfilter"
              - 'echo "br_netfilter" | sudo tee /etc/modules-load.d/br_netfilter.conf'
          rollback:
            args: # pass the bash commands to run
              - "/etc/modules-load.d/br_netfilter.conf" # filepath to remove
              - "modprobe -r br_netfilter" # bash command to remove the br_netfilter module
    - name: InstallBasePackagesWorkflow
      description: Install required base packages for Kubernetes provisioning
      steps:
        - name: InstallPackagesStep
          description: Install iptables package
          run:
            args:
              - "iptables" # package name
              - "true" # force install
          rollback:
            skip: false # by default, rollback is not skipped, so we can uninstall the package if needed.
        - name: BashScriptStep # BashScriptStep can also be used for simple commands instead of a custom InstallPackagesStep.
          description: Install gpg package
          run:
            args:
              - "apt install -y gpg"
          rollback:
            args:
              - "apt uninstall -y gpg"
        - name: InstallPackagesStep
          description: Install conntrack package
          run:
            args:
              - "conntrack"
              - "true" # force install
          rollback:
            skip: false
        - name: InstallPackagesStep
          description: Install socat package
          run:
            args:
              - "socat" # package name
              - "true" # force install
          rollback:
            skip: false
        - name: InstallPackagesStep
          description: Install ebtables package
          run:
            args:
              - "ebtables" # package name
              - "true" # force install
          rollback:
            skip: false
        - name: InstallPackagesStep
          description: Install nftables package
          run:
            args:
              - "nftables" # package name
              - "true" # force install
          rollback:
            skip: false
    - name: ConfigureNftablesWorkflow
      description: Enable and configure nftables service
      steps:
        - name: SystemCtlServiceStep
          description: Enable nftables service
          run:
            args:
              - "nftables" # service name
              - "enable" # action to perform
          rollback: # Nop.
            args:
              - "nftables" # service name
              - "disable" # action to perform
        - name: SystemCtlServiceStep
          description: Start nftables service
          run:
            args:
              - "nftables" # service name
              - "start" # action to perform
          rollback: # Nop.
            args:
              - "nftables" # service name
              - "stop" # action to perform
    - name: ConfigureSysctlWorkflow
      description: Enable and configure sysctl for Kubernetes provisioning
      steps:
        - name: CopyFilesStep # this is different to CopyFileStep, FIXME: do we need CopyFilesStep then?
          description: Backup existing sysctl configuration files
          run: # first arg is boolean followed by the dest a list of source and destination pairs separated by ':'
            - "false" # do not throw error if the files do not exist or copy fails for any item
            - "/etc/sysctl.d/15-network-performance.conf:/etc/sysctl.d/15-network-performance.conf.bak"
            - "/etc/sysctl.d/15-k8s-networking.conf:/etc/sysctl.d/15-k8s-networking.conf.bak"
            - "/etc/sysctl.d/15-inotify.conf:/etc/sysctl.d/15-inotify.conf.bak"
          rollback: # Nop.
        - name: RemoveFilesStep
          description: Clean up old sysctl configuration files
          user: root # Run as root to remove system files.
          run:
            - "false" # do not throw error if the files do not exist or remove fails for any item
            - "/etc/sysctl.d/15-network-performance.conf" # file to remove
            - "/etc/sysctl.d/15-k8s-networking.conf"
            - "/etc/sysctl.d/15-inotify.conf"
          rollback: # Nop.
        - name: BashScriptStep
          description: Configure k8s network performance settings
          run:
            - cp /etc/sysctl.d/75-k8s-networking.conf /etc/sysctl.d/75-k8s-networking.conf.bak || true
            - |
              cat <<EOF | sudo tee /etc/sysctl.d/75-k8s-networking.conf
              net.bridge.bridge-nf-call-iptables = 1
              net.bridge.bridge-nf-call-ip6tables = 1
              net.ipv4.ip_forward = 1
              net.ipv6.conf.all.forwarding = 1
              EOF
          rollback:
            - "mv /etc/sysctl.d/75-k8s-networking.conf.bak /etc/sysctl.d/75-k8s-networking.conf"
        - name: BashScriptStep
          description: Configure network performance settings
          run:
            - "cp /etc/sysctl.d/75-network-performance.conf /etc/sysctl.d/75-network-performance.conf.bak || true"
            - |
              cat <<EOF | sudo tee /etc/sysctl.d/75-network-performance.conf
              net.core.rmem_default = 31457280
              net.core.wmem_default = 31457280
              net.core.rmem_max = 33554432
              net.core.wmem_max = 33554432
              net.core.somaxconn = 65535
              net.core.netdev_max_backlog = 65535
              net.core.optmem_max = 25165824
              net.ipv4.tcp_synack_retries = 2
              net.ipv4.tcp_rmem = 8192 65536 33554432
              net.ipv4.tcp_mem = 786432 1048576 26777216
              net.ipv4.udp_mem = 65536 131072 262144
              net.ipv4.udp_rmem_min = 16384
              net.ipv4.tcp_wmem = 8192 65536 33554432
              net.ipv4.udp_wmem_min = 16384
              net.ipv4.tcp_max_tw_buckets = 1440000
              net.ipv4.tcp_tw_reuse = 1
              net.ipv4.tcp_rfc1337 = 1
              net.ipv4.tcp_syncookies = 1
              net.ipv4.tcp_fin_timeout = 15
              net.ipv4.tcp_keepalive_time = 300
              net.ipv4.tcp_keepalive_intvl = 15
              fs.file-max = 2097152
              vm.swappiness = 10
              vm.dirty_ratio = 60
              vm.dirty_background_ratio = 2
              EOF
          rollback:
            - "mv /etc/sysctl.d/75-network-performance.conf.bak /etc/sysctl.d/75-network-performance.conf"
        - name: BashScriptStep
          description: Configure inotify settings
          run:
            - cp /etc/sysctl.d/75-inotify.conf /etc/sysctl.d/75-inotify.conf.bak || true
            - |
              cat <<EOF | sudo tee /etc/sysctl.d/75-inotify.conf
              fs.inotify.max_user_watches = 524288
              fs.inotify.max_user_instances = 512
              EOF
          rollback:
            args:
              - "mv /etc/sysctl.d/75-inotify.conf.bak /etc/sysctl.d/75-inotify.conf"
        - name: BashScriptStep
          description: Apply all sysctl settings
          run:
            args: # pass the bash commands to run
              - "sysctl --system" # reload all sysctl settings
          rollback: # Nop.
    - name: FetchPackagesWorkflow
      description: Download, verify, and extract required binaries for Kubernetes provisioning
      workflows:
        - name: FetchCrioWorkflow
          description: Download, verify, and extract CRI-O binary
          steps:
            - name: DownloadBinaryStep
              description: Download CRI-O binary
              run:
                args:
                  - "crio" # binary name
              rollback: # Nop.
              # Run: See ubuntu-production.sh
            - name: VerifyBinaryStep
              description: Verify CRI-O binary checksum
              # Run: See ubuntu-production.sh
            - name: ExtractBinaryStep
              description: Unpack and extract CRI-O binary to /opt/sandbox/bin
              # Run: See ubuntu-production.sh
        - name: FetchKubeadmWorkflow
          description: Download, verify, and extract kubeadm binary
          steps:
            DownloadBinaryStep:
              description: Download kubeadm binary
            VerifyBinaryStep:
              description: Verify kubeadm binary checksum
            ExtractBinaryStep:
              description: Unpack and extract kubeadm binary to /opt/sandbox/bin
        - name: FetchKubeletWorkflow
          description: Download, verify, and extract kubelet binary
          steps:
            DownloadBinaryStep:
              description: Download kubelet binary
            VerifyBinaryStep:
              description: Verify kubelet binary checksum
            ExtractBinaryStep:
              description: Unpack and extract kubelet binary to /opt/sandbox/bin
        - name: FetchKubectlWorkflow
          description: Download, verify, and extract kubectl binary
          steps:
            DownloadBinaryStep:
              description: Download kubectl binary
            VerifyBinaryStep:
              description: Verify kubectl binary checksum
            ExtractBinaryStep:
              description: Unpack and extract kubectl binary to /opt/sandbox/bin
        - name: FetchK9sWorkflow
          description: Download, verify, and extract K9s binary
          steps:
            DownloadBinaryStep:
              description: Download K9s binary
            VerifyBinaryStep:
              description: Verify K9s binary checksum
            ExtractBinaryStep:
              description: Unpack and extract K9s binary to /opt/sandbox/bin
        - name: FetchHelmWorkflow
          description: Download, verify, and extract Helm binary
          steps:
            DownloadBinaryStep:
              description: Download Helm binary
            VerifyBinaryStep:
              description: Verify Helm binary checksum
            ExtractBinaryStep:
              description: Unpack and extract Helm binary to /opt/sandbox/bin
        - name: FetchCiliumCLIWorkflow
          description: Download, verify, and extract Cilium CLI binary
          steps:
            DownloadBinaryStep:
              description: Download Cilium CLI binary
            VerifyBinaryStep:
              description: Verify Cilium CLI SHA256 checksum
            ExtractBinaryStep:
              description: Unpack and extract Cilium CLI binary to /opt/sandbox/bin
    - name: SetupServicesAndConfigWorkflow
      description: Configure systemd services and CRI-O/Kubernetes settings
      steps:
        - name: SetupSystemdServicesStep
          description: Copy and modify systemd service files for kubelet and CRI-O to use sandbox paths
          # Run: See ubuntu-production.sh
        - name: SetupCrioConfigStep
          description: Create and update CRI-O configuration files using dasel
          # Run: See ubuntu-production.sh
        - name: SetupSystemdSymlinksStep
          description: Set up symlinks for systemd service files
          # Run: See ubuntu-production.sh
    - name: SetPermissionsAndMountsWorkflow
      description: Set correct permissions and mount points for directories
      steps:
        - name: SetProvisionerOwnershipStep
          description: Set ownership of provisioner directories to the current user
          run:
            - sudo chown -R "${USER}:${GROUP}" "${PROVISIONER_HOME}"
          rollback: # Nop.
        - name: SetSandboxOwnershipStep
          description: Set ownership of sandbox directories to root
          run:
            - sudo chown -R "root:root" "${SANDBOX_DIR}"
          rollback: # Nop.
        - name: SetupBindMountsStep
          description: Set up bind mounts for /etc/kubernetes and /var/lib/kubelet to sandbox equivalents
          run:
            - sudo mkdir -p /etc/kubernetes /var/lib/kubelet
            - |
              if ! grep -q "/etc/kubernetes" /etc/fstab; then
                echo "${SANDBOX_DIR}/etc/kubernetes /etc/kubernetes none bind,nofail 0 0" | sudo tee -a /etc/fstab >/dev/null
              fi
            - |
              if ! grep -q "/var/lib/kubelet" /etc/fstab; then
                echo "${SANDBOX_DIR}/var/lib/kubelet /var/lib/kubelet none bind,nofail 0 0" | sudo tee -a /etc/fstab >/dev/null
              fi
          rollback: # Nop.
        - name: ApplyBindMountsStep
          description: Mount these directories
          run:
            - mount /etc/kubernetes
            - mount /var/lib/kubelet
          rollback: # Nop.
    - name: ActivateCoreServicesWorkflow
      description: Enable and start core services (CRI-O, kubelet)
      steps:
        - name: ReloadSystemdStep
          description: Reload systemd daemon
          run:
            - systemctl daemon-reload
          rollback: # Nop.
        - name: EnableStartServicesStep
          description: Enable and start CRI-O and kubelet services
          run:
            - systemctl enable crio
            - systemctl start crio
            - systemctl enable kubelet
            - systemctl start kubelet
          rollback: # Nop.
    - name: InitializeKubernetesClusterWorkflow
      description: Initialize the Kubernetes cluster
      steps:
        - name: ResetKubeadmStep
          description: Reset any previous kubeadm configuration
          run:
            - kubeadm reset -f
          rollback: # Nop.
        - name: CleanupK8sDataStep
          description: Clean up old Kubernetes and etcd data
          run:
            - rm -rf /etc/kubernetes/*
            - rm -rf /var/lib/etcd/*
          rollback: # Nop.
        - name: GenerateKubeadmConfigStep
          description: Generate kubeadm configuration file with bootstrap token and machine IP
          # Run: See ubuntu-production.sh
        - name: InitKubeadmStep
          description: Initialize the Kubernetes cluster with kubeadm
          run:
            - kubeadm init --config=kubeadm-config.yaml
          rollback: # Nop.
        - name: SetupKubeconfigStep
          description: Set up kubeconfig for the current user
          run:
            - cp /etc/kubernetes/admin.conf $HOME/.kube/config
          rollback: # Nop.
    - name: SetupCiliumCNIWorkflow
      description: Install and configure CNI (Cilium)
      steps:
        - name: GenerateCiliumConfigStep
          description: Generate and apply Cilium configuration
          # Run: See ubuntu-production.sh
        - name: InstallCiliumStep
          description: Install Cilium CNI
          run:
            - cilium install --values cilium-values.yaml
          rollback: # Nop.
        - name: RestartCNIServiceStep
          description: Restart kubelet and CRI-O to ensure CNI is ready
          run:
            - systemctl restart kubelet
            - systemctl restart crio
          rollback: # Nop.
        - name: CheckCiliumReadyStep
          description: Wait for Cilium to be ready
          run:
            - kubectl get pods -n kube-system -l k8s-app=cilium
          rollback: # Nop.
    - name: SetupMetalLBLoadBalancerWorkflow
      description: Install and configure load balancer (MetalLB)
      steps:
        - name: AddHelmRepoStep
          description: Add Helm repo for MetalLB
          run:
            - helm repo add metallb https://metallb.github.io/metallb
            - helm repo update
          rollback: # Nop.
        - name: InstallMetalLBStep
          description: Install MetalLB via Helm
          run:
            - helm install metallb metallb/metallb --namespace metallb-system --create-namespace
          rollback: # Nop.
        - name: ApplyMetalLBConfigStep
          description: Apply MetalLB configuration for IP pools and L2 advertisement
          run:
            - kubectl apply -f metallb-config.yaml
          rollback: # Nop.