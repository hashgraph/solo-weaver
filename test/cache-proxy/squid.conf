# SPDX-License-Identifier: Apache-2.0
# Squid Configuration for Solo Weaver Cache Proxy

# HTTP and HTTPS port with SSL Bump
http_port 3128 ssl-bump cert=/etc/squid/certs/ca-cert.pem key=/etc/squid/certs/ca-key.pem generate-host-certificates=on dynamic_cert_mem_cache_size=16MB

# SSL certificate generation
sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/squid/ssl_db -M 16MB
sslcrtd_children 5 startup=1 idle=1

# SSL Bump - peek and bump everything
acl step1 at_step SslBump1
ssl_bump peek step1
ssl_bump bump all
sslproxy_cert_error allow all

# Basic ACLs
acl localnet src 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16 127.0.0.1/32 ::1/128
acl SSL_ports port 443
acl Safe_ports port 80 443 1025-65535
acl CONNECT method CONNECT

# Exclude container registries (let them handle their own caching)
acl container_registries dstdomain .docker.io .docker.com .gcr.io .quay.io .azurecr.io .amazonaws.com

# Exclude Go module proxy (let GOPROXY handle it)
acl go_proxy dstdomain proxy.golang.org sum.golang.org

# Don't cache container registries or Go modules
cache deny container_registries
cache deny go_proxy

# Access control
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localnet
http_access deny all

# Cache directory - 10GB
cache_dir ufs /var/cache/squid 10000 16 256
cache_mem 256 MB
maximum_object_size 500 MB
minimum_object_size 1 KB

########################
# Refresh patterns
########################

# CRI-O and container runtime binaries - cache aggressively for 30 days
refresh_pattern -i (storage\.googleapis\.com/cri-o|github\.com/.*/releases/download) \
    43200 100% 525600 ignore-no-cache ignore-private ignore-no-store ignore-must-revalidate \
    ignore-reload ignore-auth override-expire override-lastmod

# Kubernetes binaries and related artifacts - cache aggressively for 30 days
refresh_pattern -i (dl\.k8s\.io|cdn\.dl\.k8s\.io|storage\.googleapis\.com) \
    43200 100% 525600 ignore-no-cache ignore-private ignore-no-store ignore-must-revalidate \
    ignore-reload ignore-auth override-expire override-lastmod

# Helm charts and other package downloads (tar.gz, tgz, zip, deb, rpm) - cache for 7 days
refresh_pattern -i \.(tar\.gz|tgz|zip|deb|rpm)$ \
    10080 100% 525600 ignore-no-cache ignore-private ignore-no-store ignore-must-revalidate \
    ignore-reload ignore-auth override-expire override-lastmod

# GitHub raw content (systemd services, configs, etc.) - cache for 7 days
refresh_pattern -i (raw\.githubusercontent\.com|gist\.githubusercontent\.com) \
    10080 100% 525600 ignore-no-cache ignore-private ignore-no-store ignore-must-revalidate \
    ignore-reload ignore-auth override-expire override-lastmod

# Generic catch-all for other HTTPS content - cache for 1 day
refresh_pattern -i . \
    1440 50% 10080 ignore-no-cache ignore-private ignore-no-store ignore-must-revalidate \
    ignore-reload ignore-auth override-expire override-lastmod

# Logging
access_log stdio:/var/log/squid/access.log squid
cache_log /var/log/squid/cache.log
cache_store_log none

# Basic settings
visible_hostname solo-weaver-squid-proxy
coredump_dir /var/cache/squid
pid_filename /var/run/squid/squid.pid
dns_nameservers 8.8.8.8 8.8.4.4
icp_port 0
