# SPDX-License-Identifier: Apache-2.0
# Squid Configuration for Solo Weaver Cache Proxy

# HTTP and HTTPS port with SSL Bump
http_port 3128 ssl-bump cert=/etc/squid/certs/ca-cert.pem key=/etc/squid/certs/ca-key.pem generate-host-certificates=on dynamic_cert_mem_cache_size=16MB

# SSL certificate generation
sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/squid/ssl_db -M 16MB
sslcrtd_children 5 startup=1 idle=1

# SSL Bump - intercept all HTTPS traffic to cache content
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

# Bump all traffic: peek at step1 (inspect TLS Client Hello without terminating),
# stare at step2 (examine server certificate and decide policy),
# bump at step3 (perform full SSL interception/decryption).
ssl_bump peek step1
ssl_bump stare step2
ssl_bump bump step3

# Basic ACLs
acl localnet src 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16 127.0.0.1/32 ::1/128
acl SSL_ports port 443
acl Safe_ports port 80 443 1025-65535
acl CONNECT method CONNECT

# Exclude container registries (let them handle their own caching)
acl container_registries dstdomain .docker.io .docker.com .gcr.io .quay.io .azurecr.io .amazonaws.com

# Exclude Go module proxy (let GOPROXY handle it)
acl go_proxy dstdomain proxy.golang.org sum.golang.org

# Don't cache container registries or Go modules
cache deny container_registries
cache deny go_proxy

# Access control - MUST allow CONNECT for SSL bump to work
http_access deny !Safe_ports
http_access allow CONNECT SSL_ports localnet
http_access allow localnet
http_access deny all

# Cache directory - 10GB
cache_dir ufs /var/cache/squid 10000 16 256
cache_mem 256 MB
maximum_object_size 500 MB
minimum_object_size 1 KB

# Force caching even when origin sends restrictive headers
refresh_all_ims on
ignore_expect_100 on
collapsed_forwarding on

# Ignore Vary headers that might prevent cache reuse
# Even if store_id normalizes the URL, Vary can cause separate cache entries
vary_ignore_expire on

# Normalize URLs by stripping query parameters for caching
# This allows GitHub release assets and container registry blobs with different
# authentication tokens to be served from the same cached copy
store_id_program /usr/local/bin/store-id-helper.pl
store_id_children 5 startup=1 idle=1

########################
# Refresh patterns
########################

# GitHub release assets - MUST be first to catch these URLs
# These have signed Azure blob URLs with expiring tokens that we strip via store_id
refresh_pattern -i release-assets\.githubusercontent\.com \
    43200 100% 525600 ignore-no-cache ignore-private ignore-no-store ignore-must-revalidate \
    ignore-reload ignore-auth override-expire override-lastmod reload-into-ims

# GitHub container registry blobs - immutable content by SHA256
refresh_pattern -i pkg-containers\.githubusercontent\.com/ghcr1/blobs \
    43200 100% 525600 ignore-no-cache ignore-private ignore-no-store ignore-must-revalidate \
    ignore-reload ignore-auth override-expire override-lastmod reload-into-ims

# Specific: Kubernetes binaries on cdn.dl.k8s.io - versioned, immutable, cache forever
refresh_pattern -i cdn\.dl\.k8s\.io/release/v[0-9.]+/bin \
    525600 100% 525600 ignore-no-cache ignore-private ignore-no-store ignore-must-revalidate \
    ignore-reload ignore-auth override-expire override-lastmod reload-into-ims

# Specific: Kubernetes binaries on dl.k8s.io - just redirects, short cache
refresh_pattern -i dl\.k8s\.io/release \
    1440 50% 10080 ignore-no-cache ignore-private

# Specific: Helm releases - versioned, immutable
refresh_pattern -i get\.helm\.sh/helm-v[0-9.]+ \
    525600 100% 525600 ignore-no-cache ignore-private ignore-no-store ignore-must-revalidate \
    ignore-reload ignore-auth override-expire override-lastmod reload-into-ims

# Specific: CRI-O versioned archives - immutable
refresh_pattern -i storage\.googleapis\.com/cri-o/artifacts/.*\.v[0-9.]+\.tar\.gz \
    525600 100% 525600 ignore-no-cache ignore-private ignore-no-store ignore-must-revalidate \
    ignore-reload ignore-auth override-expire override-lastmod reload-into-ims

# Specific: Helm chart repositories (index.yaml files) - cache for 1 hour, revalidate
refresh_pattern -i (metallb\.github\.io|kubernetes-sigs\.github\.io)/.*/index\.yaml \
    60 50% 1440 ignore-no-cache ignore-private ignore-reload reload-into-ims

# Generic: Any .tar.gz, .tgz with version numbers - likely immutable
refresh_pattern -i /v[0-9.]+/.*\.(tar\.gz|tgz)$ \
    525600 100% 525600 ignore-no-cache ignore-private ignore-no-store ignore-must-revalidate \
    ignore-reload ignore-auth override-expire override-lastmod reload-into-ims

# Fallback: Other package downloads (tar.gz, tgz, zip, deb, rpm) - cache for 7 days
refresh_pattern -i \.(tar\.gz|tgz|zip|deb|rpm)$ \
    10080 100% 525600 ignore-no-cache ignore-private ignore-no-store ignore-must-revalidate \
    ignore-reload ignore-auth override-expire override-lastmod

# GitHub raw content (systemd services, configs, etc.) - cache for 7 days
refresh_pattern -i (raw\.githubusercontent\.com|gist\.githubusercontent\.com) \
    10080 100% 525600 ignore-no-cache ignore-private ignore-no-store ignore-must-revalidate \
    ignore-reload ignore-auth override-expire override-lastmod

# Generic catch-all for other HTTPS content - cache for 1 day
refresh_pattern -i . \
    1440 50% 10080 ignore-no-cache ignore-private ignore-no-store ignore-must-revalidate \
    ignore-reload ignore-auth override-expire override-lastmod

# Logging
access_log stdio:/var/log/squid/access.log squid
cache_log /var/log/squid/cache.log
cache_store_log stdio:/var/log/squid/store.log

# Basic settings
visible_hostname solo-weaver-squid-proxy
coredump_dir /var/cache/squid
pid_filename /var/run/squid/squid.pid
dns_nameservers 8.8.8.8 8.8.4.4
icp_port 0
