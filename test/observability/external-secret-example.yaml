# Example External Secret configuration for Grafana Alloy
# This demonstrates how to configure ESO to sync secrets from Vault
# to create the grafana-alloy-secrets Kubernetes secret

---
# Step 1: Create ClusterSecretStore (cluster-wide, points to Vault)
apiVersion: external-secrets.io/v1
kind: ClusterSecretStore
metadata:
  name: vault-secret-store
spec:
  provider:
    vault:
      server: "https://vault.example.com"
      path: "secret"
      version: v2
      auth:
        # Option 1: User/Password authentication
        userPass:
          path: userpass
          username: "my-app-user"
          secretRef:
            name: vault-credentials
            namespace: kube-system
            key: password

        # Option 2: Kubernetes authentication (uncomment to use)
        # kubernetes:
        #   mountPath: "kubernetes"
        #   role: "my-app-role"
        #   serviceAccountRef:
        #     name: "external-secrets"

---
# Step 2: Create Vault credentials secret (for userPass auth)
# Skip this if using Kubernetes auth
apiVersion: v1
kind: Secret
metadata:
  name: vault-credentials
  namespace: kube-system
type: Opaque
stringData:
  password: "your-vault-password-here"

---
# Step 3: Create ExternalSecret for Alloy credentials
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: grafana-alloy-external-secret
  namespace: grafana-alloy
spec:
  # Refresh secrets from Vault every hour
  refreshInterval: 1h

  # Reference the ClusterSecretStore
  secretStoreRef:
    name: vault-secret-store
    kind: ClusterSecretStore

  # Target K8s secret to create
  target:
    name: grafana-alloy-secrets  # ‚Üê This is the name Alloy expects!
    creationPolicy: Owner
    template:
      type: Opaque
      engineVersion: v2

  # Map Vault secrets to K8s secret keys
  data:
    - secretKey: PROMETHEUS_PASSWORD
      remoteRef:
        key: "grafana/alloy/prometheus"
        property: password

    - secretKey: LOKI_PASSWORD
      remoteRef:
        key: "grafana/alloy/loki"
        property: password

---
# How to use this configuration:

# 1. Store secrets in Vault:
#    vault kv put secret/grafana/alloy/prometheus password="your-prometheus-password"
#    vault kv put secret/grafana/alloy/loki password="your-loki-password"

# 2. Apply this manifest BEFORE installing the cluster:
#    kubectl create namespace grafana-alloy
#    kubectl apply -f external-secret-example.yaml

# 3. Install cluster with external secrets config:
#    weaver kube cluster install \
#      --config=config-with-external-secrets.yaml \
#      --node-type=block \
#      --profile=production

# 4. Verify the secret was created by ESO:
#    kubectl get secret grafana-alloy-secrets -n grafana-alloy
#    kubectl get externalsecret -n grafana-alloy

# The ExternalSecret will automatically:
# - Fetch passwords from Vault
# - Create the grafana-alloy-secrets K8s secret
# - Keep the secret in sync with Vault (refreshed every hour)

